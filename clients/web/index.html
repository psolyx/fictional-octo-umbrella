<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'wasm-unsafe-eval'; connect-src 'self' ws: wss:; img-src 'self' data:; style-src 'self'; object-src 'none'; base-uri 'none'; frame-ancestors 'none'" />
  <title>Gateway WebSocket demo</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>Gateway v1 WebSocket demo</h1>
  <p>This static page exercises gateway session lifecycle, conversation subscription with optional replay, ack, and ciphertext send flows.</p>

  <fieldset>
    <legend>Connection</legend>
    <label>
      Gateway WS URL
      <input type="text" id="gateway_url" size="64" placeholder="ws://localhost:8787/v1/ws" />
    </label>
    <label>
      auth_token (for session.start)
      <input type="text" id="bootstrap_token" size="48" />
    </label>
    <label>
      device_id
      <input type="text" id="device_id" size="32" />
    </label>
    <label>
      device_credential
      <input type="text" id="device_credential" size="48" />
    </label>
    <label>
      Resume token (for session.resume)
      <input type="text" id="resume_token" size="48" />
    </label>
    <div class="button-row">
      <button id="connect_start">Start session</button>
      <button id="connect_resume">Resume session</button>
      <span id="connection_status">disconnected</span>
    </div>
  </fieldset>

  <fieldset>
    <legend>Conversation controls</legend>
    <label>
      Conversation ID
      <input type="text" id="conv_id" size="32" />
    </label>
    <label>
      from_seq (optional subscribe replay)
      <input type="number" id="from_seq" min="0" />
    </label>
    <label>
      seq
      <input type="number" id="seq" min="0" />
    </label>
    <label>
      msg_id
      <input type="text" id="msg_id" size="24" />
    </label>
    <label>
      Ciphertext payload
      <input type="text" id="ciphertext_input" size="64" />
    </label>
    <div class="button-row">
      <button id="subscribe_btn">Subscribe</button>
      <button id="ack_btn">Ack</button>
      <button id="send_btn">Send ciphertext</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Social (Polycentric)</legend>
    <p>Fetch signed social events via gateway HTTP and optionally use an author as a DM bootstrap peer.</p>
    <label>
      social_user_id
      <input type="text" id="social_user_id" size="48" placeholder="u_..." />
    </label>
    <label>
      limit
      <input type="number" id="social_limit" min="1" max="200" value="20" />
    </label>
    <div class="button-row">
      <button id="social_fetch_btn">Fetch events</button>
      <span id="social_status">idle</span>
    </div>
    <label>
      debug_etag
      <input type="text" id="social_etag" size="64" readonly />
    </label>
    <div id="social_event_list"></div>

    <details>
      <summary>Publish (advanced/debug)</summary>
      <p>Advanced path: paste a precomputed signature; browser-side signing is intentionally out of scope.</p>
      <label>
        prev_hash (optional)
        <input type="text" id="social_prev_hash" size="64" />
      </label>
      <label>
        kind
        <input type="text" id="social_kind" size="24" value="post" />
      </label>
      <label>
        ts_ms
        <input type="number" id="social_ts_ms" min="0" />
      </label>
      <label>
        payload_json
        <textarea id="social_payload_json" rows="4" cols="64">{"text":"hello"}</textarea>
      </label>
      <label>
        sig_b64
        <input type="text" id="social_sig_b64" size="64" />
      </label>
      <div class="button-row">
        <button id="social_publish_btn">Publish event</button>
      </div>
    </details>
  </fieldset>

  <fieldset>
    <legend>Received events</legend>
    <div id="event_log"></div>
  </fieldset>

  <fieldset>
    <legend>Debug log</legend>
    <textarea id="debug_log" readonly></textarea>
    <button id="clear_log">Clear log</button>
  </fieldset>

  <fieldset>
    <legend>MLS vectors</legend>
    <p>Verify the deterministic DM vector with the Go harness compiled to WASM.</p>
    <div class="button-row">
      <button id="run_vectors">Run vectors</button>
      <span id="vector_status">idle</span>
    </div>
    <pre id="vector_output"></pre>
  </fieldset>

  <fieldset>
    <legend>MLS DM (local)</legend>
    <p>Local-only DM flow using the Go WASM harness. Participant state can be saved to IndexedDB and reloaded after refresh.</p>
    <div class="button-row">
      <button id="dm_create_alice">Create Alice</button>
      <button id="dm_create_bob">Create Bob</button>
      <button id="dm_reset_state">Reset local state</button>
      <span id="dm_status">idle</span>
    </div>
    <label>
      group_id (base64)
      <input type="text" id="dm_group_id" size="48" readonly />
    </label>
    <div class="button-row">
      <button id="dm_init">Init (Alice → Bob)</button>
      <button id="dm_join">Join (Bob)</button>
      <button id="dm_commit_apply">Apply commit (Alice)</button>
    </div>
    <label>
      Alice plaintext (local only)
      <input type="text" id="dm_alice_plaintext" size="48" placeholder="hello from alice" />
    </label>
    <button id="dm_encrypt_alice">Encrypt Alice → Bob</button>
    <label>
      Bob plaintext (local only)
      <input type="text" id="dm_bob_plaintext" size="48" placeholder="hello from bob" />
    </label>
    <button id="dm_encrypt_bob">Encrypt Bob → Alice</button>
    <label>
      Last ciphertext (base64)
      <input type="text" id="dm_ciphertext" size="64" readonly />
    </label>
    <label>
      Last decrypted plaintext (local only)
      <input type="text" id="dm_decrypted" size="48" readonly />
    </label>
    <div class="button-row">
      <button id="dm_save_state">Save to IndexedDB</button>
      <button id="dm_load_state">Load from IndexedDB</button>
    </div>
    <pre id="dm_output"></pre>
  </fieldset>

  <script src="vendor/wasm_exec.js"></script>
  <script type="module" src="vectors_ui.js"></script>
  <script type="module" src="dm_ui.js"></script>
  <script type="module" src="social_ui.js"></script>
  <script src="gateway_ws_client.js"></script>
</body>
</html>
