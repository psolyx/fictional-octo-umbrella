<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'wasm-unsafe-eval'; connect-src 'self' ws: wss:; img-src 'self' data:; style-src 'self'; object-src 'none'; base-uri 'none'; frame-ancestors 'none'" />
  <title>Gateway WebSocket demo</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="live_status" class="sr-only" aria-live="polite" aria-atomic="true"></div>
  <h1>Gateway v1 WebSocket demo</h1>
  <p>This static page exercises gateway session lifecycle, conversation subscription with optional replay, ack, and ciphertext send flows.</p>


  <fieldset>
    <legend>Account</legend>
    <div class="button-row">
      <button id="account_generate_btn">Generate identity</button>
      <button id="account_export_btn">Export identity JSON</button>
      <button id="account_rotate_device_btn">Rotate device</button>
      <button id="account_logout_btn">Logout</button>
      <span id="account_status_line">ready: no identity loaded</span>
    </div>
    <label>
      Import identity JSON
      <textarea id="account_import_json" rows="4" cols="64"></textarea>
    </label>
    <button id="account_import_btn">Import identity JSON</button>
  </fieldset>

  <fieldset>
    <legend>Connection</legend>
    <label>
      Gateway WS URL
      <input type="text" id="gateway_url" size="64" placeholder="ws://localhost:8787/v1/ws" />
    </label>
    <label>
      auth_token (for session.start)
      <input type="text" id="bootstrap_token" size="48" />
    </label>
    <label>
      device_id
      <input type="text" id="device_id" size="32" />
    </label>
    <label>
      device_credential
      <input type="text" id="device_credential" size="48" />
    </label>
    <label>
      Resume token (for session.resume)
      <input type="text" id="resume_token" size="48" />
    </label>
    <div class="button-row">
      <button id="connect_start">Start session</button>
      <button id="connect_resume">Resume session</button>
      <span id="connection_status" aria-live="polite">disconnected</span>
    </div>
  </fieldset>

  <div id="replay_window_banner" class="replay-window-banner" aria-live="polite" hidden>
    <span id="replay_window_text">History pruned.</span>
    <button id="replay_window_resubscribe_btn" type="button">Click to resubscribe</button>
  </div>


  <fieldset>
    <legend>Conversations</legend>
    <div class="button-row">
      <button id="conversations_refresh_btn" type="button">Refresh conversations</button>
      <span id="conversations_status" aria-live="polite">idle</span>
    </div>
    <p>Legend: unread=N comes from server read state. pruned means your read pointer is behind retained history.</p>
    <ul id="conversations_list" role="listbox" aria-label="Conversations"></ul>
  </fieldset>


  <fieldset>
    <legend>Presence</legend>
    <label><input type="checkbox" id="presence_enabled_toggle" checked /> Presence enabled</label>
    <label><input type="checkbox" id="presence_invisible_toggle" /> Invisible mode</label>
    <p id="presence_status_line" aria-live="polite">presence: idle</p>
    <p id="selected_presence_status" data-test="presence-indicator">Selected conversation presence: unavailable</p>
  </fieldset>

  <fieldset>
    <legend>Conversation controls</legend>
    <label>
      Conversation ID
      <input type="text" id="conv_id" size="32" />
    </label>
    <p id="conv_id_error" class="field-error" hidden></p>
    <label>
      from_seq (optional subscribe replay)
      <input type="number" id="from_seq" min="0" />
    </label>
    <label>
      seq
      <input type="number" id="seq" min="0" />
    </label>
    <label>
      msg_id
      <input type="text" id="msg_id" size="24" />
    </label>
    <label>
      Ciphertext payload
      <input type="text" id="ciphertext_input" size="64" />
    </label>
    <p id="compose_error" class="field-error" hidden></p>
    <p id="dm_block_banner" class="blocked-banner" tabindex="0" aria-live="polite" hidden></p>
    <div class="button-row">
      <button id="subscribe_btn">Subscribe</button>
      <button id="ack_btn">Ack</button>
      <button id="send_btn">Send ciphertext</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Social (Polycentric)</legend>
    <p id="myspace_profile_marker">MySpace-style profile</p>
    <label>
      social_user_id
      <input type="text" id="social_user_id" size="48" placeholder="u_..." />
    </label>
    <label>
      limit
      <input type="number" id="social_limit" min="1" max="200" value="20" />
    </label>
    <div class="button-row">
      <button id="social_fetch_btn">Fetch events</button>
      <button id="profile_refresh_btn">Refresh profile</button>
      <button id="feed_refresh_btn">Refresh home feed</button>
      <span id="social_status">idle</span>
    </div>
    <label>
      debug_etag
      <input type="text" id="social_etag" size="64" readonly />
    </label>
    <div id="social_event_list"></div>

    <section class="profile_shell">
      <div id="profile_banner" class="profile_banner"></div>
      <div class="profile_headline">
        <img id="profile_avatar" class="profile_avatar" alt="profile avatar" />
        <h3 id="profile_username">username</h3>
      </div>
      <div id="profile_about" class="profile_card"><h4>About Me</h4><p id="profile_about_text">—</p></div>
      <div id="profile_interests" class="profile_card"><h4>Interests</h4><p id="profile_interests_text">—</p></div>
      <div id="profile_friends" class="profile_card"><h4>Friends</h4><ul id="profile_friends_list"></ul></div>
      <div id="profile_bulletins" class="profile_card"><h4>Latest Bulletins</h4><ul id="profile_bulletins_list"></ul></div>
      <div class="button-row">
        <button id="follow_toggle_btn">Add Friend</button>
        <button id="profile_message_btn" data-test="start-dm" type="button">Message</button>
        <button id="profile_block_toggle_btn" data-test="block-toggle" type="button">Block</button>
        <span id="profile_block_status" aria-live="polite"></span>
      </div>
    </section>

    <section class="profile_card">
      <h4>Home feed</h4>
      <div id="home_feed" class="home_feed"></div>
    </section>

    <section class="profile_card">
      <h4>Pending publishes</h4>
      <div id="social_publish_queue" aria-live="polite"></div>
    </section>

    <section class="profile_card">
      <h4>Post bulletin</h4>
      <label>Bulletin text <input type="text" id="bulletin_text" size="64" /></label>
      <button id="bulletin_post_btn">Post bulletin</button>
    </section>

    <section class="profile_card">
      <h4>Update profile</h4>
      <label>Username <input type="text" id="profile_username_input" size="48" aria-invalid="false" /></label>
      <p id="username_field_error" class="field-error" data-test="field-error"></p>
      <label>Description <input type="text" id="profile_description_input" size="64" aria-invalid="false" /></label>
      <p id="description_field_error" class="field-error" data-test="field-error"></p>
      <label>Avatar URL/data <input type="text" id="profile_avatar_input" size="64" aria-invalid="false" /></label>
      <p id="avatar_field_error" class="field-error" data-test="field-error"></p>
      <label>Banner URL/data <input type="text" id="profile_banner_input" size="64" aria-invalid="false" /></label>
      <p id="banner_field_error" class="field-error" data-test="field-error"></p>
      <label>Interests <input type="text" id="profile_interests_input" size="64" aria-invalid="false" /></label>
      <p id="interests_field_error" class="field-error" data-test="field-error"></p>
      <label>Signature (sig_b64, advanced/debug) <input type="text" id="social_sig_b64" size="64" /></label>
      <button id="profile_update_btn">Update profile</button>
    </section>

    <details>
      <summary>Publish (advanced/debug)</summary>
      <label>
        prev_hash (optional)
        <input type="text" id="social_prev_hash" size="64" />
      </label>
      <label>
        kind
        <input type="text" id="social_kind" size="24" value="post" />
      </label>
      <label>
        ts_ms
        <input type="number" id="social_ts_ms" min="0" />
      </label>
      <label>
        payload_json
        <textarea id="social_payload_json" rows="4" cols="64">{"text":"hello"}</textarea>
      </label>
      <div class="button-row">
        <button id="social_publish_btn">Publish event</button>
      </div>
    </details>
  </fieldset>

  <fieldset>
    <legend>Received events</legend>
    <div id="event_log"></div>
  </fieldset>

  <fieldset>
    <legend>Debug log</legend>
    <textarea id="debug_log" readonly></textarea>
    <button id="clear_log">Clear log</button>
  </fieldset>

  <fieldset>
    <legend>MLS vectors</legend>
    <p>Verify the deterministic DM vector with the Go harness compiled to WASM.</p>
    <div class="button-row">
      <button id="run_vectors">Run vectors</button>
      <span id="vector_status">idle</span>
    </div>
    <pre id="vector_output"></pre>
  </fieldset>

  <fieldset>
    <legend>MLS DM (local)</legend>
    <p>Local-only DM flow using the Go WASM harness. Participant state can be saved to IndexedDB and reloaded after refresh.</p>
    <div class="button-row">
      <button id="dm_create_alice">Create Alice</button>
      <button id="dm_create_bob">Create Bob</button>
      <button id="dm_reset_state">Reset local state</button>
      <span id="dm_status">idle</span>
    </div>
    <label>
      group_id (base64)
      <input type="text" id="dm_group_id" size="48" readonly />
    </label>
    <div class="button-row">
      <button id="dm_init">Init (Alice → Bob)</button>
      <button id="dm_join">Join (Bob)</button>
      <button id="dm_commit_apply">Apply commit (Alice)</button>
    </div>
    <label>
      Alice plaintext (local only)
      <input type="text" id="dm_alice_plaintext" size="48" placeholder="hello from alice" />
    </label>
    <button id="dm_encrypt_alice">Encrypt Alice → Bob</button>
    <label>
      Bob plaintext (local only)
      <input type="text" id="dm_bob_plaintext" size="48" placeholder="hello from bob" />
    </label>
    <button id="dm_encrypt_bob">Encrypt Bob → Alice</button>
    <label>
      Last ciphertext (base64)
      <input type="text" id="dm_ciphertext" size="64" readonly />
    </label>
    <label>
      Last decrypted plaintext (local only)
      <input type="text" id="dm_decrypted" size="48" readonly />
    </label>
    <div class="button-row">
      <button id="dm_save_state">Save to IndexedDB</button>
      <button id="dm_load_state">Load from IndexedDB</button>
    </div>
    <pre id="dm_output"></pre>
  </fieldset>

  <script src="vendor/wasm_exec.js"></script>
  <script type="module" src="vectors_ui.js"></script>
  <script type="module" src="dm_ui.js"></script>
  <script type="module" src="identity.js"></script>
  <script type="module" src="social_ui.js"></script>
  <script src="gateway_ws_client.js"></script>
</body>
</html>
